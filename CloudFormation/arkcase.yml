# Copyright (c) 2020 Armedia, LLC
---
AWSTemplateFormatVersion: 2010-09-09

Description: >
  Deploy ArkCase

Parameters:
  Env:
    Type: String
    Description: Type of environment to provision
    Default: prod
    AllowedValues: [ staging, prod, dev, test, load-test ]

  Project:
    Type: String
    Description: Name of the project (or product)
    Default: arkcase
    MinLength: 1
    MaxLength: 50
    AllowedPattern: ^[-a-zA-Z0-9_.]*$

  VpcCidr:
    Type: String
    Description: CIDR block for the VPC
    MinLength: 9
    MaxLength: 18
    AllowedPattern: ^\d{1,3}.\d{1,3}.\d{1,3}.\d{1,3}/\d{1,2}$
    ConstraintDescription: Must be a valid CIDR range like "10.10.0.0/16"
    Default: 10.210.0.0/16

  KeyPair:
    Type: AWS::EC2::KeyPair::KeyName
    Description: Existing key pair to associate to EC2 instances

  CertAuthorityCommonName:
    Type: String
    Description: Common name that will appear in SSL certs generated in this environment.
    MinLength: 10
    MaxLength: 64
    Default: ArkCase Research and Development Root CA V2

  MaintenanceWindowStart:
    Type: String
    Description: >
      Weekly maintenance window for the whole deployment. Must be in the
      format "DDD:HH:MM" and must be in UTC time. "DDD" is the three-letter day
      of the week (eg: "Sun"); "HH" is the hour in 24h format; "MM" is the
      minutes. We strongly recommend you use Sunday early morning in your own
      time zone. The maintenance would typically take a couple of hours.
    Default: Sun:08:00
    AllowedPattern: ^[a-zA-Z]{3}:[0-2][0-9]:[0-5][0-9]$
    ConstraintDescription: Must be in the format "DDD:HH:MM"

  DsEdition:
    Type: String
    Description: Whether Directory Services is Enterprise or Standard
    Default: Standard
    AllowedValues: [ Enterprise, Standard ]

  DsName:
    Type: String
    Description: |
      The fully qualified domain name for the AWS Managed Microsoft AD directory, such as
      corp.example.com. This name will resolve inside your VPC only. It does not need to be
      publicly resolvable.
    AllowedPattern: ^([a-zA-Z0-9]+[\\.-])+([a-zA-Z0-9])+$
    ConstraintDescription: Must be a valid fully qualified domain name.
    Default: ecmontap.com

  DsPassword:
    Type: String
    Description: |
      The password for the default administrative user named Admin. The
      password must be between 12 and 64 characters, not contain the
      word "admin", and must have at least one character from three of these
      four categories: lowercase, uppercase, numeric and special characters
    NoEcho: true
    MinLength: 12
    MaxLength: 64
    AllowedPattern: (?=^.{12,64}$)((?=.*\d)(?=.*[A-Z])(?=.*[a-z])|(?=.*\d)(?=.*[^A-Za-z0-9\s])(?=.*[a-z])|(?=.*[^A-Za-z0-9\s])(?=.*[A-Z])(?=.*[a-z])|(?=.*\d)(?=.*[A-Z])(?=.*[^A-Za-z0-9\s]))^.*
    ConstraintDescription: >
      12-64 characters; must have at least one character from three of these
      four categories: lowercase, uppercase, numeric and special characters

  RdsPasswordLength:
    Type: Number
    Description: How long database passwords should be
    Default: 20
    MinValue: 8
    MaxValue: 80

  RdsPasswordRotationInDays:
    Type: Number
    Description: How often to rotate database passwords, in days
    Default: 30
    MinValue: 1
    MaxValue: 1000

  AlfrescoRdsInstanceClass:
    Type: String
    Description: >
      RDS instance class for the Alfresco database; for more detail, refer to
      the official AWS documentation here:
      https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.DBInstanceClass.html
    MinLength: 1
    MaxLength: 20
    Default: db.t3.small

  AlfrescoRdsDiskSizeGB:
    Type: Number
    MinValue: 20
    Default: 50

  LatestWindowsServer2019AmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-windows-latest/Windows_Server-2019-English-Full-Base

  LatestAmazonLinux2AmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label: { default: IMPORTANT PARAMETERS }
        Parameters:
          - Env
          - VpcCidr
          - KeyPair
          - MaintenanceWindowStart

      - Label: { default: Definition (this and the following sections are less important) }
        Parameters:
          - Project

      - Label: { default: General database configuration }
        Parameters:
          - RdsPasswordLength
          - RdsPasswordRotationInDays

      - Label: { default: Alfresco configuration }
        Parameters:
          - AlfrescoRdsInstanceClass
          - AlfrescoRdsDiskSizeGB

      - Label: { default: Directory Services Configuration }
        Parameters:
          - DsEdition
          - DsName
          - DsPassword
          - CertAuthorityCommonName

      - Label: { default: EC2 Instance AMI IDs }
        Parameters:
          - LatestWindowsServer2019AmiId
          - LatestAmazonLinux2AmiId

    ParameterLabels:
      Env: { default: Environment }
      VpcCidr: { default: VPC CIDR block }
      KeyPair: { default: Key pair to control access to EC2 instances }
      DsEdition: { default: Directory Services Edition }
      DsName: { default: Domain Name }
      DsPassword: { default: Admin User Password }
      CertAuthorityCommonName: { default: TLS Root Certificate Common Name }
      MaintenanceWindowStart: { default: Start of weekly maintenance window }
      RdsPasswordLength: { default: RDS password length }
      RdsPasswordRotationInDays: { default: "RDS password rotation, in days" }
      AlfrescoRdsInstanceClass: { default: Alfresco RDS instance class }
      AlfrescoRdsDiskSizeGB: { default: "Alfresco RDS disk size, in GB" }
      LatestWindowsServer2019AmiId: { default: Parameter store path to a Windows Server 2019 AMI }
      LatestAmazonLinux2AmiId: { default: Parameter store path to an Amazon Linux 2 AMI }

Resources:

  #######
  # VPC #
  #######

  Vpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub vpc-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: network
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: network
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation


  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref Vpc
      InternetGatewayId: !Ref InternetGateway

  PublicSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Vpc
      CidrBlock: !Select [ 0, !Cidr [ !Ref VpcCidr, 4, 10 ] ]
      AvailabilityZone: !Select [ 0, !GetAZs ]
      Tags:
        - Key: Name
          Value: !Sub public-subnet-A-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: network
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  PublicSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Vpc
      CidrBlock: !Select [ 1, !Cidr [ !Ref VpcCidr, 4, 10 ] ]
      AvailabilityZone: !Select [ 1, !GetAZs ]
      Tags:
        - Key: Name
          Value: !Sub public-subnet-B-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: network
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  PrivateSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Vpc
      CidrBlock: !Select [ 2, !Cidr [ !Ref VpcCidr, 4, 10 ] ]
      AvailabilityZone: !Select [ 0, !GetAZs ]
      Tags:
        - Key: Name
          Value: !Sub private-subnet-A-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: network
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  PrivateSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref Vpc
      CidrBlock: !Select [ 3, !Cidr [ !Ref VpcCidr, 4, 10 ] ]
      AvailabilityZone: !Select [ 1, !GetAZs ]
      Tags:
        - Key: Name
          Value: !Sub private-subnet-B-${Project}-${Env}
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: network
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  ElasticIpForNatGatewayA:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: network
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  NatGatewayA:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt ElasticIpForNatGatewayA.AllocationId
      SubnetId: !Ref PublicSubnetA
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: network
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  ElasticIpForNatGatewayB:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: network
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  NatGatewayB:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt ElasticIpForNatGatewayB.AllocationId
      SubnetId: !Ref PublicSubnetB
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: network
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref Vpc
      Tags:
        - Key: Name
          Value: PublicRouteTable
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: network
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetA
      RouteTableId: !Ref PublicRouteTable

  PublicSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetB
      RouteTableId: !Ref PublicRouteTable

  PrivateRouteTableA:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref Vpc
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: network
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  DefaultPrivateRouteA:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTableA
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGatewayA

  PrivateSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnetA
      RouteTableId: !Ref PrivateRouteTableA

  PrivateRouteTableB:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref Vpc
      Tags:
        - Key: Name
          Value: PrivateRouteTable
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: network
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  DefaultPrivateRouteB:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTableB
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGatewayB

  PrivateSubnetBRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnetB
      RouteTableId: !Ref PrivateRouteTableB

  ###############################
  # Compute Maintenance Windows #
  ###############################

  MaintenanceWindowsLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: admin
        - Key: Component
          Value: iam
        - Key: ManagedBy
          Value: CloudFormation

  MaintenanceWindowsLambda:
    Type: AWS::Lambda::Function
    Properties:
      Description: Calculate ArkCase maintenance windows
      Runtime: python3.7
      Role: !GetAtt MaintenanceWindowsLambdaExecutionRole.Arn
      Handler: maintenance_windows_lambda.handler
      Timeout: 5
      Code:
        S3Bucket: !Sub arkcase-public-${AWS::Region}
        S3Key: DevOps/ACM-DEV-20200422-1649/maintenance_windows_lambda/maintenance_windows_lambda.zip
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: admin
        - Key: Component
          Value: lambda
        - Key: ManagedBy
          Value: CloudFormation

  MaintenanceWindows:
    Type: Custom::MaintenanceWindows
    Properties:
      ServiceToken: !GetAtt MaintenanceWindowsLambda.Arn
      Start: !Ref MaintenanceWindowStart

  ######################################
  # Microsoft Active Directory Service #
  ######################################

  DirectoryService:
    Type: AWS::DirectoryService::MicrosoftAD
    Properties:
      Name: !Ref DsName
      Password: !Ref DsPassword
      Edition: !Ref DsEdition
      VpcSettings:
        SubnetIds:
          - !Ref PrivateSubnetA
          - !Ref PrivateSubnetB
        VpcId: !Ref Vpc

  ############
  # Alfresco #
  ############

  AlfrescoSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Alfresco containers
      VpcId: !Ref Vpc
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: alfresco
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  AlfrescoDatabase:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://arkcase-public-us-east-1.s3.amazonaws.com/DevOps/ACM-DEV-20200422-1649/CloudFormation/mariadb.yml
      TimeoutInMinutes: 30
      Parameters:
        Env: !Ref Env
        Project: !Ref Project
        VpcId: !Ref Vpc
        # NB: We can't use lists when creating a nested stack, we have to
        #     expand it into a comma-separated list.
        SubnetIds: !Join [ ",", [ !Ref PrivateSubnetA, !Ref PrivateSubnetB ] ]
        AllowedSecurityGroupId: !GetAtt AlfrescoSecurityGroup.GroupId
        DatabaseName: alfresco
        InstanceClass: !Ref AlfrescoRdsInstanceClass
        DiskSizeGB: !Ref AlfrescoRdsDiskSizeGB
        EnableMultiAZ: true
        BackupWindow: !Sub ${MaintenanceWindows.StartRdsBackup}-${MaintenanceWindows.EndRdsBackup}
        MaintenanceWindow:
          !Sub ${MaintenanceWindows.StartAlfrescoRdsMaintenance}-${MaintenanceWindows.EndAlfrescoRdsMaintenance}
        AutoMinorUpgrade: true
        PasswordLength: !Ref RdsPasswordLength
        RotationInDays: !Ref RdsPasswordRotationInDays
      Tags:
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: alfresco
        - Key: Component
          Value: cfn
        - Key: ManagedBy
          Value: CloudFormation

  ##################
  # Bastion Hosts  #
  ##################
  ElasticIpForWindowsBastionA:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: ElasticIpForWindowsBastionA
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: network
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  ElasticIpForLinuxBastionA:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: ElasticIpForLinuxBastionA
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: network
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  RdpSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for RDP Servers
      VpcId: !Ref Vpc
      SecurityGroupIngress:
        - Description: Allow traffic from RDP Clients
          IpProtocol: tcp
          CidrIp: 0.0.0.0/0
          FromPort: 3389
          ToPort: 3389
      Tags:
        - Key: Name
          Value: RdpSecurityGroup
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: rdp
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  SshSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for SSH servers
      VpcId: !Ref Vpc
      SecurityGroupIngress:
        - Description: Allow traffic from SSH clients
          IpProtocol: tcp
          CidrIp: 0.0.0.0/0
          FromPort: 22
          ToPort: 22
      Tags:
        - Key: Name
          Value: SshSecurityGroup
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: rdp
        - Key: Component
          Value: vpc
        - Key: ManagedBy
          Value: CloudFormation

  ArkWindowsBastionA:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref LatestWindowsServer2019AmiId
      KeyName: !Ref KeyPair
      SubnetId: !Ref PublicSubnetA
      SecurityGroupIds:
        - !GetAtt  RdpSecurityGroup.GroupId
      Tags:
        - Key: Name
          Value: ArkWindowsBastionA
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: bastion
        - Key: Component
          Value: ec2
        - Key: ManagedBy
          Value: CloudFormation

  ArkLinuxBastionA:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref LatestAmazonLinux2AmiId
      KeyName: !Ref KeyPair
      SubnetId: !Ref PublicSubnetA
      SecurityGroupIds:
        - !GetAtt  SshSecurityGroup.GroupId
      Tags:
        - Key: Name
          Value: ArkLinuxBastionA
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: bastion
        - Key: Component
          Value: ec2
        - Key: ManagedBy
          Value: CloudFormation

  ArkWindowsBastionAElasticIP:
    Type: AWS::EC2::EIPAssociation
    Properties:
      AllocationId: !GetAtt ElasticIpForWindowsBastionA.AllocationId
      InstanceId: !Ref ArkWindowsBastionA

  ArkLinuxBastionAElasticIP:
    Type: AWS::EC2::EIPAssociation
    Properties:
      AllocationId: !GetAtt ElasticIpForLinuxBastionA.AllocationId
      InstanceId: !Ref ArkLinuxBastionA

  #########################################
  # Active Directory Certificate Services #
  #########################################

  ArkAdcsRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      Path: /
      Policies:
        - PolicyName: ssmParameterWriterRole
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action: ssm:PutParameter
                Resource: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/arkcase/adcs/*

  ArkAdcsInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - !Ref ArkAdcsRole

  ArkADCSRootCA15:
    Type: AWS::EC2::Instance
    Metadata:
      AWS::CloudFormation::Init:
        config:
          packages:
            msi:
              AWSCLIV2: https://awscli.amazonaws.com/AWSCLIV2.msi
          files:
            C:\\Windows\\CAPolicy.inf:
              content: !Sub |
                [Version]
                Signature="$Windows NT$"
                [PolicyStatementExtension]
                Policies=InternalPolicy
                [InternalPolicy]
                # the Armedia-specific OID
                OID= 1.2.3.4.1455.67.89.5
                Notice="Legal Policy Statement"
                URL=http://pki.${DsName}/pki/cps.txt
                [Certsrv_Server]
                RenewalKeyLength=4096
                RenewalValidityPeriod=Years
                RenewalValidityPeriodUnits=20
                CRLPeriod=weeks
                CRLPeriodUnits=26
                CRLDeltaPeriod=Days
                CRLDeltaPeriodUnits=0
                LoadDefaultTemplates=0
                AlternateSignatureAlgorithm=0
          commands:
            01_add_adcs_ca_feature:
              command: powershell.exe -Command "Add-WindowsFeature Adcs-Cert-Authority -IncludeManagementTools"
            02_install_adcs_ca:
              command: !Sub ECHO Y | powershell.exe -Command "Install-AdcsCertificationAuthority -CAType StandaloneRootCA -CACommonName '${CertAuthorityCommonName}' -KeyLength 4096 -HashAlgorithm SHA256 -CryptoProviderName 'RSA#Microsoft Software Key Storage Provider'"
            03_remove_default_crls:
              command: powershell.exe -Command "$crllist = Get-CACrlDistributionPoint; foreach ($crl in $crllist) {Remove-CACrlDistributionPoint $crl.uri -Force};"
            04_add_our_crl:
              command: powershell.exe -Command "Add-CACRLDistributionPoint -Uri C:\Windows\System32\CertSrv\CertEnroll\%3%8.crl -PublishToServer -Force"
            # NOTE ADCS doesn't allow https in the below command
            05_add_our_crl_dist:
              command: !Sub powershell.exe -Command "Add-CACRLDistributionPoint -Uri http://pki.${DsName}/pki/%3%8.crl -AddToCertificateCDP -Force"
            06_remove_default_aia:
              command: powershell.exe -Command "$aialist = Get-CAAuthorityInformationAccess; foreach ($aia in $aialist) {Remove-CAAuthorityInformationAccess $aia.uri -Force};"
            07_set_overlap_period_units:
              command: certutil -setreg CA\CRLOverlapPeriodUnits 12
            08_set_overlap_period:
              command: certutil -setreg CA\CRLOverlapPeriod "Hours"
            09_set_validity_period_units:
              command: certutil -setreg CA\ValidityPeriodUnits 10
            10_set_validity_period:
              command: certutil -setreg CA\ValidityPeriod "Years"
            11_set_audit_filter:
              command: certutil -setreg CA\AuditFilter 127
            12_restart_certsvc:
              command: powershell.exe -Command "restart-service certsvc"
            13_configure_crl:
              command: certutil -crl
            14_write_crl_to_ssm_param:
              command: !Sub powershell.exe -Command "$file = Get-ChildItem -Path C:\Windows\System32\CertSrv\CertEnroll\*.crl ; cd C:\Windows\System32\CertSrv\CertEnroll ; $crl = [Convert]::ToBase64String([IO.File]::ReadAllBytes($file)) ; C:\PROGRA~1\Amazon\AWSCLIV2\aws ssm put-parameter --region ${AWS::Region} --overwrite --name /arkcase/adcs/adcs_crl --type SecureString --value $crl"
            15_write_cert_to_ssm_param:
              command: !Sub powershell.exe -Command "$file = Get-ChildItem -Path C:\Windows\System32\CertSrv\CertEnroll\*.crt ; cd C:\Windows\System32\CertSrv\CertEnroll ; $crt = [Convert]::ToBase64String([IO.File]::ReadAllBytes($file)) ; C:\PROGRA~1\Amazon\AWSCLIV2\aws ssm put-parameter --region ${AWS::Region} --overwrite --name /arkcase/adcs/adcs_crt --type SecureString --value $crt"
    CreationPolicy:
      ResourceSignal:
        Count: 1
        Timeout: PT30M
    Properties:
      ImageId: !Ref LatestWindowsServer2019AmiId
      IamInstanceProfile: !Ref ArkAdcsInstanceProfile
      KeyName: !Ref KeyPair
      DisableApiTermination: true
      SubnetId: !Ref PrivateSubnetA
      SecurityGroupIds:
        - !GetAtt  RdpSecurityGroup.GroupId
      UserData:
        Fn::Base64: !Sub |
          <script>
          cfn-init.exe -v --stack ${AWS::StackId} --resource ArkADCSRootCA15 --region ${AWS::Region} --configsets default
          cfn-signal.exe -e %errorlevel% --stack ${AWS::StackId} --resource ArkADCSRootCA15 --region ${AWS::Region}
          </script>
      Tags:
        - Key: Name
          Value: ArkADCSRootCA15
        - Key: Env
          Value: !Ref Env
        - Key: Project
          Value: !Ref Project
        - Key: Service
          Value: ADCS
        - Key: Component
          Value: ec2
        - Key: ManagedBy
          Value: CloudFormation
Outputs:
  StartBlockTraffic:
    Description: Begin weekly maintenance window
    Value: !GetAtt MaintenanceWindows.StartBlockTraffic
  StartRdsBackup:
    Description: When to start backing up RDS instances
    Value: !GetAtt MaintenanceWindows.StartRdsBackup
  EndRdsBackup:
    Description: When to end backing up RDS instances
    Value: !GetAtt MaintenanceWindows.EndRdsBackup
  StartAlfrescoRdsMaintenance:
    Description: When to start maintenance of the Alfresco RDS instance
    Value: !GetAtt MaintenanceWindows.StartAlfrescoRdsMaintenance
  EndAlfrescoRdsMaintenance:
    Description: When to end maintenance of the Alfresco RDS instance
    Value: !GetAtt MaintenanceWindows.EndAlfrescoRdsMaintenance
  StartAmazonmqMaintenanceDayOfWeek:
    Description: When to start maintenance of AmazonMQ (day of week)
    Value: !GetAtt MaintenanceWindows.StartAmazonmqMaintenanceDayOfWeek
  StartAmazonmqMaintenanceTimeOfDay:
    Description: When to start maintenance of AmazonMQ (time of day)
    Value: !GetAtt MaintenanceWindows.StartAmazonmqMaintenanceTimeOfDay
  EndBlockTraffic:
    Description: End weekly maintenance window
    Value: !GetAtt MaintenanceWindows.EndBlockTraffic
